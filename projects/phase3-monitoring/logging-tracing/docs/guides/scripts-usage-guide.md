# äº‘åŸç”Ÿæ—¥å¿—æ”¶é›†ä¸åˆ†æé¡¹ç›®è„šæœ¬ä½¿ç”¨è¯´æ˜

## è„šæœ¬æ¦‚è§ˆ

æœ¬é¡¹ç›®æä¾›äº†ä¸‰ä¸ªä¸»è¦è„šæœ¬æ¥ç®¡ç†äº‘åŸç”Ÿå¯è§‚æµ‹æ€§ç³»ç»Ÿï¼š

1. **scripts/setup.sh** - ä¸€é”®éƒ¨ç½²è„šæœ¬
2. **scripts/test.sh** - åŠŸèƒ½æµ‹è¯•è„šæœ¬
3. **scripts/cleanup.sh** - ç¯å¢ƒæ¸…ç†è„šæœ¬

æ‰€æœ‰è„šæœ¬éƒ½ä½äº `scripts/` ç›®å½•ä¸­ï¼Œä¿æŒé¡¹ç›®ç»“æ„çš„æ•´æ´æ€§ã€‚

## 1. éƒ¨ç½²è„šæœ¬ (scripts/setup.sh)

### åŠŸèƒ½æè¿°
è‡ªåŠ¨éƒ¨ç½²å®Œæ•´çš„äº‘åŸç”Ÿå¯è§‚æµ‹æ€§æ ˆï¼ŒåŒ…æ‹¬ï¼š
- Elasticsearch é›†ç¾¤ï¼ˆæ—¥å¿—å­˜å‚¨ï¼‰
- Fluent Bitï¼ˆæ—¥å¿—æ”¶é›†å™¨ï¼‰
- Kibanaï¼ˆæ—¥å¿—å¯è§†åŒ–ï¼‰
- Jaegerï¼ˆé“¾è·¯è¿½è¸ªï¼‰
- ç¤ºä¾‹å¾®æœåŠ¡åº”ç”¨

### ä½¿ç”¨æ–¹æ³•
```bash
cd scripts
./setup.sh
```

### å‰ç½®æ¡ä»¶
- Kubernetes é›†ç¾¤æ­£åœ¨è¿è¡Œ
- kubectl å·²é…ç½®å¹¶å¯è¿æ¥é›†ç¾¤
- Docker å·²å®‰è£…ï¼ˆç”¨äºæ„å»ºé•œåƒï¼‰
- å¦‚æœä½¿ç”¨ minikubeï¼Œä¼šè‡ªåŠ¨å¯ç”¨å­˜å‚¨æä¾›ç¨‹åº

### éƒ¨ç½²æµç¨‹
1. æ£€æŸ¥å‰ç½®æ¡ä»¶
2. åˆ›å»º logging å’Œ tracing å‘½åç©ºé—´
3. éƒ¨ç½² Elasticsearchï¼ˆä½¿ç”¨ç®€åŒ–é…ç½®ï¼‰
4. éƒ¨ç½² Fluent Bitï¼ˆè‡ªåŠ¨è·å– ES Pod IPï¼‰
5. éƒ¨ç½² Kibanaï¼ˆè‡ªåŠ¨è·å– ES Pod IPï¼‰
6. éƒ¨ç½² Jaegerï¼ˆä½¿ç”¨å†…å­˜å­˜å‚¨ï¼‰
7. æ„å»ºå¹¶éƒ¨ç½²ç”¨æˆ·æœåŠ¡
8. éªŒè¯æ‰€æœ‰ç»„ä»¶çŠ¶æ€

### ç‰¹æ®Šå¤„ç†
- è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç† DNS è§£æé—®é¢˜
- ä½¿ç”¨ Pod IP æ›¿ä»£æœåŠ¡åè¿›è¡Œç»„ä»¶é—´é€šä¿¡
- å…¼å®¹ Elasticsearch 8.x ç‰ˆæœ¬
- è‡ªåŠ¨æ„å»ºå’ŒåŠ è½½ç”¨æˆ·æœåŠ¡ Docker é•œåƒ

## 2. æµ‹è¯•è„šæœ¬ (test.sh)

### åŠŸèƒ½æè¿°
å…¨é¢æµ‹è¯•å¯è§‚æµ‹æ€§ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶å’Œæ•°æ®æµï¼š

### æµ‹è¯•é¡¹ç›®
1. **åŸºç¡€è¿æ¥æµ‹è¯•**
   - Kubernetes é›†ç¾¤è¿æ¥
   - å‘½åç©ºé—´æ£€æŸ¥

2. **ç»„ä»¶éƒ¨ç½²æµ‹è¯•**
   - Elasticsearch éƒ¨ç½²çŠ¶æ€
   - Fluent Bit éƒ¨ç½²çŠ¶æ€
   - Kibana éƒ¨ç½²çŠ¶æ€
   - Jaeger éƒ¨ç½²çŠ¶æ€
   - ç”¨æˆ·æœåŠ¡éƒ¨ç½²çŠ¶æ€

3. **API åŠŸèƒ½æµ‹è¯•**
   - Elasticsearch API å“åº”
   - Kibana API çŠ¶æ€
   - Jaeger API åŠŸèƒ½
   - ç”¨æˆ·æœåŠ¡å¥åº·æ£€æŸ¥
   - ç”¨æˆ·æœåŠ¡ä¸šåŠ¡åŠŸèƒ½

4. **æ•°æ®æµæµ‹è¯•**
   - Elasticsearch æ•°æ®å­˜åœ¨æ€§
   - è¿½è¸ªæ•°æ®ç”Ÿæˆ
   - è´Ÿè½½ç”Ÿæˆæµ‹è¯•
   - ç«¯åˆ°ç«¯æ•°æ®æµéªŒè¯

### ä½¿ç”¨æ–¹æ³•
```bash
cd scripts
./test.sh
```

### è¾“å‡ºç¤ºä¾‹
```
==========================================
ğŸ§ª äº‘åŸç”Ÿå¯è§‚æµ‹æ€§ç³»ç»Ÿæµ‹è¯•
==========================================

[INFO] æµ‹è¯• 1: Kubernetes é›†ç¾¤è¿æ¥
[SUCCESS] âœ… Kubernetes é›†ç¾¤è¿æ¥
...
==========================================
ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»
==========================================
æ€»æµ‹è¯•æ•°: 16
é€šè¿‡: 16
å¤±è´¥: 0
æˆåŠŸç‡: 100%

[SUCCESS] ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸
```

## 3. æ¸…ç†è„šæœ¬ (cleanup.sh)

### åŠŸèƒ½æè¿°
å®Œå…¨æ¸…ç†éƒ¨ç½²çš„æ‰€æœ‰ç»„ä»¶å’Œèµ„æºï¼š

### æ¸…ç†å†…å®¹
1. åº”ç”¨æœåŠ¡ï¼ˆç”¨æˆ·æœåŠ¡ï¼‰
2. Jaeger è¿½è¸ªç³»ç»Ÿ
3. Kibana å¯è§†åŒ–å¹³å°
4. Fluent Bit æ—¥å¿—æ”¶é›†å™¨
5. Elasticsearch é›†ç¾¤
6. ç›¸å…³å‘½åç©ºé—´
7. Docker é•œåƒï¼ˆå¯é€‰ï¼‰
8. ç«¯å£è½¬å‘è¿›ç¨‹

### ä½¿ç”¨æ–¹æ³•
```bash
cd scripts
./cleanup.sh
```

### äº¤äº’å¼é€‰é¡¹
è„šæœ¬ä¼šè¯¢é—®æ˜¯å¦æ¸…ç† Docker é•œåƒï¼š
```
æ˜¯å¦æ¸…ç† Docker é•œåƒï¼Ÿ(y/N):
```

### å®‰å…¨ç‰¹æ€§
- ä½¿ç”¨ `--ignore-not-found=true` é¿å…åˆ é™¤ä¸å­˜åœ¨èµ„æºæ—¶æŠ¥é”™
- ç­‰å¾…èµ„æºåˆ é™¤å®Œæˆåå†åˆ é™¤å‘½åç©ºé—´
- æ¸…ç†ç«¯å£è½¬å‘è¿›ç¨‹é¿å…ç«¯å£å ç”¨

## ä½¿ç”¨åœºæ™¯

### å®Œæ•´éƒ¨ç½²æµç¨‹
```bash
# 1. éƒ¨ç½²ç³»ç»Ÿ
cd scripts
./setup.sh

# 2. éªŒè¯éƒ¨ç½²
./test.sh

# 3. ä½¿ç”¨ç³»ç»Ÿ...

# 4. æ¸…ç†ç¯å¢ƒ
./cleanup.sh
```

### å¼€å‘è°ƒè¯•æµç¨‹
```bash
# å¿«é€Ÿæµ‹è¯•å½“å‰çŠ¶æ€
cd scripts
./test.sh

# å¦‚æœæœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹å…·ä½“ç»„ä»¶çŠ¶æ€
kubectl get pods -n logging
kubectl get pods -n tracing
kubectl logs -n logging <pod-name>

# é‡æ–°éƒ¨ç½²ç‰¹å®šç»„ä»¶
cd ..
kubectl delete -f manifests/elasticsearch/
kubectl apply -f manifests/elasticsearch/elasticsearch-simple.yaml
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **å­˜å‚¨æä¾›ç¨‹åºé—®é¢˜**
   ```bash
   minikube addons enable storage-provisioner
   ```

2. **DNS è§£æé—®é¢˜**
   - è„šæœ¬ä¼šè‡ªåŠ¨ä½¿ç”¨ Pod IP æ›¿ä»£æœåŠ¡å

3. **é•œåƒæ‹‰å–é—®é¢˜**
   ```bash
   # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
   minikube image ls | grep user-service
   
   # é‡æ–°æ„å»ºå’ŒåŠ è½½
   cd apps/user-service
   docker build -t user-service:latest .
   minikube image load user-service:latest
   ```

4. **ç«¯å£å†²çª**
   ```bash
   # æ¸…ç†ç«¯å£è½¬å‘è¿›ç¨‹
   pkill -f "kubectl port-forward"
   ```

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹ç»„ä»¶æ—¥å¿—
kubectl logs -n logging -l app=elasticsearch
kubectl logs -n logging -l app=fluent-bit
kubectl logs -n logging -l app=kibana
kubectl logs -n tracing -l app=jaeger
kubectl logs -l app=user-service

# æŸ¥çœ‹äº‹ä»¶
kubectl get events -n logging
kubectl get events -n tracing
```

## è®¿é—®åœ°å€

éƒ¨ç½²å®Œæˆåï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®å„ç»„ä»¶ï¼š

### ç«¯å£è½¬å‘æ–¹å¼
```bash
# Elasticsearch
kubectl port-forward -n logging svc/elasticsearch 9200:9200

# Kibana
kubectl port-forward -n logging svc/kibana 5601:5601

# Jaeger
kubectl port-forward -n tracing svc/jaeger-query 16686:16686

# ç”¨æˆ·æœåŠ¡
kubectl port-forward svc/user-service 8080:8080
```

### NodePort æ–¹å¼ï¼ˆå¦‚æœæ”¯æŒï¼‰
- Elasticsearch: http://\<node-ip\>:30920
- Kibana: http://\<node-ip\>:30561  
- Jaeger: http://\<node-ip\>:30686

## æ³¨æ„äº‹é¡¹

1. **èµ„æºè¦æ±‚**: ç¡®ä¿é›†ç¾¤æœ‰è¶³å¤Ÿçš„ CPU å’Œå†…å­˜èµ„æº
2. **ç½‘ç»œç­–ç•¥**: æŸäº›é›†ç¾¤å¯èƒ½æœ‰ç½‘ç»œç­–ç•¥é™åˆ¶
3. **å­˜å‚¨**: ä½¿ç”¨ emptyDir å­˜å‚¨ï¼Œé‡å¯åæ•°æ®ä¼šä¸¢å¤±
4. **å®‰å…¨**: æ‰€æœ‰ç»„ä»¶éƒ½ç¦ç”¨äº†å®‰å…¨è®¤è¯ï¼Œä»…ç”¨äºå­¦ä¹ ç¯å¢ƒ

## æ‰©å±•åŠŸèƒ½

### æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹
åœ¨ `test.sh` ä¸­æ·»åŠ æ–°çš„æµ‹è¯•å‡½æ•°ï¼š
```bash
test_new_feature() {
    # æµ‹è¯•é€»è¾‘
    return 0  # æˆåŠŸ
}

# åœ¨ main å‡½æ•°ä¸­è°ƒç”¨
run_test "æ–°åŠŸèƒ½æµ‹è¯•" "test_new_feature"
```

### è‡ªå®šä¹‰éƒ¨ç½²é…ç½®
ä¿®æ”¹ `manifests/` ç›®å½•ä¸‹çš„ YAML æ–‡ä»¶æ¥è‡ªå®šä¹‰éƒ¨ç½²é…ç½®ã€‚
