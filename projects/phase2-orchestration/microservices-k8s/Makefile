# ==============================================================================
# å¾®æœåŠ¡Kuberneteséƒ¨ç½²é¡¹ç›® - Makefile
# é¡¹ç›®ç®¡ç†å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·
# ==============================================================================

.PHONY: help build-images deploy status clean test scale-all get-url logs health check

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¡¹ç›®é…ç½®
PROJECT_NAME := microservices-k8s
NAMESPACE := ecommerce-k8s
DOCKER_REGISTRY := # ç•™ç©ºä½¿ç”¨æœ¬åœ°é•œåƒ
IMAGE_TAG := 1.0
REPLICAS := 2

# ç¬¬ä¸€é˜¶æ®µé¡¹ç›®è·¯å¾„
ECOMMERCE_BASIC_PATH := ../../phase1-containerization/ecommerce-basic

# é¢œè‰²å®šä¹‰
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
CYAN := \033[0;36m
NC := \033[0m

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(CYAN)å¾®æœåŠ¡Kuberneteséƒ¨ç½²é¡¹ç›® - ç®¡ç†å‘½ä»¤$(NC)"
	@echo "========================================="
	@echo ""
	@echo "$(YELLOW)æ„å»ºå‘½ä»¤:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)ä½¿ç”¨ç¤ºä¾‹:$(NC)"
	@echo "  make build-images  # æ„å»ºæ‰€æœ‰å¾®æœåŠ¡é•œåƒ"
	@echo "  make deploy        # éƒ¨ç½²åˆ°Kubernetes"
	@echo "  make status        # æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€"
	@echo "  make test          # è¿è¡Œæµ‹è¯•"
	@echo "  make clean         # æ¸…ç†èµ„æº"

build-images: ## æ„å»ºæ‰€æœ‰å¾®æœåŠ¡é•œåƒ
	@echo "$(CYAN)ğŸ”¨ æ„å»ºå¾®æœåŠ¡é•œåƒ...$(NC)"
	@if [ ! -d "$(ECOMMERCE_BASIC_PATH)" ]; then \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°ç¬¬ä¸€é˜¶æ®µé¡¹ç›®: $(ECOMMERCE_BASIC_PATH)$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ğŸ“ åˆ‡æ¢åˆ°ç¬¬ä¸€é˜¶æ®µé¡¹ç›®ç›®å½•$(NC)"
	@cd $(ECOMMERCE_BASIC_PATH) && \
	if command -v minikube >/dev/null 2>&1 && minikube status >/dev/null 2>&1; then \
		echo "$(BLUE)ğŸ³ é…ç½®Minikube Dockerç¯å¢ƒ$(NC)"; \
		eval $$(minikube docker-env) && make build; \
	else \
		echo "$(BLUE)ğŸ³ ä½¿ç”¨æœ¬åœ°Dockerç¯å¢ƒ$(NC)"; \
		make build; \
	fi
	@echo "$(GREEN)âœ… é•œåƒæ„å»ºå®Œæˆ$(NC)"

check-images: ## æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
	@echo "$(CYAN)ğŸ” æ£€æŸ¥é•œåƒçŠ¶æ€...$(NC)"
	@if command -v minikube >/dev/null 2>&1 && minikube status >/dev/null 2>&1; then \
		eval $$(minikube docker-env) && \
		docker images | grep -E "(user-service|product-service|order-service|notification-service)" || \
		(echo "$(YELLOW)âš ï¸  é•œåƒä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ make build-images$(NC)" && exit 1); \
	else \
		docker images | grep -E "(user-service|product-service|order-service|notification-service)" || \
		(echo "$(YELLOW)âš ï¸  é•œåƒä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ make build-images$(NC)" && exit 1); \
	fi
	@echo "$(GREEN)âœ… é•œåƒæ£€æŸ¥é€šè¿‡$(NC)"

create-namespace: ## åˆ›å»ºå‘½åç©ºé—´
	@echo "$(CYAN)ğŸ“¦ åˆ›å»ºå‘½åç©ºé—´ $(NAMESPACE)...$(NC)"
	@kubectl create namespace $(NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
	@echo "$(GREEN)âœ… å‘½åç©ºé—´åˆ›å»ºå®Œæˆ$(NC)"

deploy-secrets: ## éƒ¨ç½²å¯†é’¥é…ç½®
	@echo "$(CYAN)ğŸ” éƒ¨ç½²å¯†é’¥é…ç½®...$(NC)"
	@kubectl apply -f k8s/secrets/
	@echo "$(GREEN)âœ… å¯†é’¥é…ç½®å®Œæˆ$(NC)"

deploy-configmaps: ## éƒ¨ç½²é…ç½®æ˜ å°„
	@echo "$(CYAN)âš™ï¸  éƒ¨ç½²é…ç½®æ˜ å°„...$(NC)"
	@kubectl apply -f k8s/configmaps/
	@echo "$(GREEN)âœ… é…ç½®æ˜ å°„å®Œæˆ$(NC)"

deploy-storage: ## éƒ¨ç½²å­˜å‚¨é…ç½®
	@echo "$(CYAN)ğŸ’¾ éƒ¨ç½²å­˜å‚¨é…ç½®...$(NC)"
	@kubectl apply -f k8s/storage/
	@echo "$(GREEN)âœ… å­˜å‚¨é…ç½®å®Œæˆ$(NC)"

deploy-infrastructure: ## éƒ¨ç½²åŸºç¡€è®¾æ–½
	@echo "$(CYAN)ğŸ—ï¸  éƒ¨ç½²åŸºç¡€è®¾æ–½æœåŠ¡...$(NC)"
	@kubectl apply -f k8s/infrastructure/
	@echo "$(BLUE)â³ ç­‰å¾…åŸºç¡€è®¾æ–½æœåŠ¡å°±ç»ª...$(NC)"
	@kubectl wait --for=condition=ready pod -l tier=infrastructure -n $(NAMESPACE) --timeout=300s || echo "$(YELLOW)âš ï¸  åŸºç¡€è®¾æ–½å¯åŠ¨å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´$(NC)"
	@echo "$(GREEN)âœ… åŸºç¡€è®¾æ–½éƒ¨ç½²å®Œæˆ$(NC)"

deploy-microservices: ## éƒ¨ç½²å¾®æœåŠ¡
	@echo "$(CYAN)ğŸš€ éƒ¨ç½²å¾®æœåŠ¡åº”ç”¨...$(NC)"
	@kubectl apply -f k8s/microservices/
	@echo "$(BLUE)â³ ç­‰å¾…å¾®æœåŠ¡å°±ç»ª...$(NC)"
	@kubectl wait --for=condition=ready pod -l tier=backend -n $(NAMESPACE) --timeout=300s || echo "$(YELLOW)âš ï¸  å¾®æœåŠ¡å¯åŠ¨å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´$(NC)"
	@echo "$(GREEN)âœ… å¾®æœåŠ¡éƒ¨ç½²å®Œæˆ$(NC)"

deploy-gateway: ## éƒ¨ç½²APIç½‘å…³
	@echo "$(CYAN)ğŸŒ éƒ¨ç½²APIç½‘å…³...$(NC)"
	@kubectl apply -f k8s/gateway/
	@echo "$(BLUE)â³ ç­‰å¾…ç½‘å…³å°±ç»ª...$(NC)"
	@kubectl wait --for=condition=ready pod -l tier=frontend -n $(NAMESPACE) --timeout=120s || echo "$(YELLOW)âš ï¸  ç½‘å…³å¯åŠ¨å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´$(NC)"
	@echo "$(GREEN)âœ… APIç½‘å…³éƒ¨ç½²å®Œæˆ$(NC)"

deploy-ingress: ## éƒ¨ç½²Ingressé…ç½®
	@echo "$(CYAN)ğŸ”— éƒ¨ç½²Ingressé…ç½®...$(NC)"
	@kubectl apply -f k8s/ingress/ || echo "$(YELLOW)âš ï¸  Ingressé…ç½®å¯é€‰ï¼Œå¦‚æœªå®‰è£…Ingressæ§åˆ¶å™¨åˆ™è·³è¿‡$(NC)"
	@echo "$(GREEN)âœ… Ingressé…ç½®å®Œæˆ$(NC)"

deploy: check-images create-namespace deploy-secrets deploy-configmaps deploy-storage deploy-infrastructure deploy-microservices deploy-gateway deploy-ingress ## å®Œæ•´éƒ¨ç½²æ‰€æœ‰ç»„ä»¶
	@echo "$(GREEN)ğŸ‰ éƒ¨ç½²å®Œæˆï¼$(NC)"
	@echo ""
	@make status
	@echo ""
	@make get-url

status: ## æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
	@echo "$(CYAN)ğŸ“Š éƒ¨ç½²çŠ¶æ€æ£€æŸ¥$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ å‘½åç©ºé—´çŠ¶æ€:$(NC)"
	@kubectl get ns $(NAMESPACE) 2>/dev/null || echo "$(RED)âŒ å‘½åç©ºé—´ä¸å­˜åœ¨$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸš€ PodçŠ¶æ€:$(NC)"
	@kubectl get pods -n $(NAMESPACE) -o wide 2>/dev/null || echo "$(RED)âŒ æ— Podè¿è¡Œ$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸŒ æœåŠ¡çŠ¶æ€:$(NC)"
	@kubectl get services -n $(NAMESPACE) 2>/dev/null || echo "$(RED)âŒ æ— æœåŠ¡è¿è¡Œ$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“Š éƒ¨ç½²çŠ¶æ€:$(NC)"
	@kubectl get deployments -n $(NAMESPACE) 2>/dev/null || echo "$(RED)âŒ æ— éƒ¨ç½²$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ’¾ å­˜å‚¨çŠ¶æ€:$(NC)"
	@kubectl get pvc -n $(NAMESPACE) 2>/dev/null || echo "$(BLUE)â„¹ï¸  æ— æŒä¹…åŒ–å­˜å‚¨$(NC)"

health: ## å¥åº·æ£€æŸ¥
	@echo "$(CYAN)ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥...$(NC)"
	@./scripts/health-check.sh || echo "$(YELLOW)âš ï¸  å¥åº·æ£€æŸ¥è„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸºç¡€æ£€æŸ¥$(NC)"
	@echo ""
	@echo "$(BLUE)ğŸ” æ£€æŸ¥å…³é”®ç»„ä»¶çŠ¶æ€:$(NC)"
	@for component in postgres redis rabbitmq user-service product-service order-service notification-service api-gateway; do \
		echo -n "  $$component: "; \
		if kubectl get pods -l app=$$component -n $(NAMESPACE) | grep -q "1/1.*Running"; then \
			echo "$(GREEN)âœ… å¥åº·$(NC)"; \
		else \
			echo "$(RED)âŒ å¼‚å¸¸$(NC)"; \
		fi; \
	done

get-url: ## è·å–è®¿é—®åœ°å€
	@echo "$(CYAN)ğŸŒ è·å–è®¿é—®åœ°å€...$(NC)"
	@if command -v minikube >/dev/null 2>&1 && minikube status >/dev/null 2>&1; then \
		echo "$(GREEN)ğŸ“ Minikubeè®¿é—®åœ°å€:$(NC)"; \
		minikube service api-gateway -n $(NAMESPACE) --url 2>/dev/null || echo "$(YELLOW)âš ï¸  APIç½‘å…³æœåŠ¡æœªå°±ç»ª$(NC)"; \
	else \
		NODE_PORT=$$(kubectl get service api-gateway -n $(NAMESPACE) -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null); \
		if [ -n "$$NODE_PORT" ]; then \
			echo "$(GREEN)ğŸ“ NodePortè®¿é—®åœ°å€: http://<èŠ‚ç‚¹IP>:$$NODE_PORT$(NC)"; \
		else \
			echo "$(YELLOW)âš ï¸  æ— æ³•è·å–è®¿é—®åœ°å€ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€$(NC)"; \
		fi; \
	fi
	@echo ""
	@echo "$(BLUE)ğŸ’¡ æç¤º: ä¹Ÿå¯ä»¥ä½¿ç”¨ç«¯å£è½¬å‘è®¿é—®$(NC)"
	@echo "kubectl port-forward service/api-gateway 8080:80 -n $(NAMESPACE)"

logs: ## æŸ¥çœ‹æœåŠ¡æ—¥å¿—
	@echo "$(CYAN)ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—...$(NC)"
	@./scripts/logs.sh || kubectl logs -l tier=backend -n $(NAMESPACE) --tail=50

verify: ## éªŒè¯éƒ¨ç½²çŠ¶æ€
	@echo "$(CYAN)ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€...$(NC)"
	@if [ -f "scripts/verify-deployment.sh" ]; then \
		./scripts/verify-deployment.sh; \
	else \
		echo "$(YELLOW)âš ï¸  éªŒè¯è„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸºç¡€æ£€æŸ¥$(NC)"; \
		make health; \
	fi

test: ## è¿è¡ŒAPIæµ‹è¯•
	@echo "$(CYAN)ğŸ§ª è¿è¡ŒAPIæµ‹è¯•...$(NC)"
	@if [ -f "tests/api-tests.sh" ]; then \
		./tests/api-tests.sh; \
	else \
		echo "$(YELLOW)âš ï¸  æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨æµ‹è¯•:$(NC)"; \
		echo "kubectl run test-pod --image=busybox --rm -it --restart=Never -n $(NAMESPACE) -- sh"; \
	fi

load-test: ## è¿è¡Œè´Ÿè½½æµ‹è¯•
	@echo "$(CYAN)âš¡ è¿è¡Œè´Ÿè½½æµ‹è¯•...$(NC)"
	@if [ -f "tests/load-tests.sh" ]; then \
		./tests/load-tests.sh; \
	else \
		echo "$(YELLOW)âš ï¸  è´Ÿè½½æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨$(NC)"; \
	fi

scale: ## æ‰©ç¼©å®¹æœåŠ¡ (ä½¿ç”¨: make scale SERVICE=user-service REPLICAS=5)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šæœåŠ¡åç§°: make scale SERVICE=user-service REPLICAS=5$(NC)"; \
		exit 1; \
	fi
	@if [ -z "$(REPLICAS)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šå‰¯æœ¬æ•°: make scale SERVICE=user-service REPLICAS=5$(NC)"; \
		exit 1; \
	fi
	@echo "$(CYAN)ğŸ“ˆ æ‰©ç¼©å®¹ $(SERVICE) åˆ° $(REPLICAS) ä¸ªå‰¯æœ¬...$(NC)"
	@kubectl scale deployment $(SERVICE) --replicas=$(REPLICAS) -n $(NAMESPACE)
	@echo "$(GREEN)âœ… æ‰©ç¼©å®¹å®Œæˆ$(NC)"

scale-all: ## æ‰©ç¼©å®¹æ‰€æœ‰å¾®æœåŠ¡ (ä½¿ç”¨: make scale-all REPLICAS=3)
	@if [ -z "$(REPLICAS)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šå‰¯æœ¬æ•°: make scale-all REPLICAS=3$(NC)"; \
		exit 1; \
	fi
	@echo "$(CYAN)ğŸ“ˆ æ‰©ç¼©å®¹æ‰€æœ‰å¾®æœåŠ¡åˆ° $(REPLICAS) ä¸ªå‰¯æœ¬...$(NC)"
	@for service in user-service product-service order-service notification-service; do \
		echo "$(BLUE)ğŸ“Š æ‰©ç¼©å®¹ $$service...$(NC)"; \
		kubectl scale deployment $$service --replicas=$(REPLICAS) -n $(NAMESPACE); \
	done
	@echo "$(GREEN)âœ… æ‰€æœ‰æœåŠ¡æ‰©ç¼©å®¹å®Œæˆ$(NC)"

restart: ## é‡å¯æŒ‡å®šæœåŠ¡ (ä½¿ç”¨: make restart SERVICE=user-service)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šæœåŠ¡åç§°: make restart SERVICE=user-service$(NC)"; \
		exit 1; \
	fi
	@echo "$(CYAN)ğŸ”„ é‡å¯ $(SERVICE)...$(NC)"
	@kubectl rollout restart deployment $(SERVICE) -n $(NAMESPACE)
	@kubectl rollout status deployment $(SERVICE) -n $(NAMESPACE)
	@echo "$(GREEN)âœ… $(SERVICE) é‡å¯å®Œæˆ$(NC)"

clean: ## æ¸…ç†æ‰€æœ‰èµ„æº
	@echo "$(YELLOW)âš ï¸  è­¦å‘Š: è¿™å°†åˆ é™¤ $(NAMESPACE) å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰èµ„æº$(NC)"
	@read -p "ç¡®è®¤ç»§ç»­? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "$(CYAN)ğŸ—‘ï¸  æ¸…ç†èµ„æº...$(NC)"; \
		kubectl delete namespace $(NAMESPACE) --ignore-not-found=true; \
		echo "$(GREEN)âœ… èµ„æºæ¸…ç†å®Œæˆ$(NC)"; \
	else \
		echo "$(BLUE)â„¹ï¸  æ“ä½œå·²å–æ¶ˆ$(NC)"; \
	fi

clean-force: ## å¼ºåˆ¶æ¸…ç†æ‰€æœ‰èµ„æº
	@echo "$(CYAN)ğŸ—‘ï¸  å¼ºåˆ¶æ¸…ç†èµ„æº...$(NC)"
	@kubectl delete namespace $(NAMESPACE) --ignore-not-found=true
	@echo "$(GREEN)âœ… èµ„æºæ¸…ç†å®Œæˆ$(NC)"

update: ## æ›´æ–°æŒ‡å®šæœåŠ¡é•œåƒ (ä½¿ç”¨: make update SERVICE=user-service IMAGE=user-service:v2.0)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šæœåŠ¡åç§°: make update SERVICE=user-service IMAGE=user-service:v2.0$(NC)"; \
		exit 1; \
	fi
	@if [ -z "$(IMAGE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šé•œåƒ: make update SERVICE=user-service IMAGE=user-service:v2.0$(NC)"; \
		exit 1; \
	fi
	@echo "$(CYAN)ğŸ”„ æ›´æ–° $(SERVICE) é•œåƒåˆ° $(IMAGE)...$(NC)"
	@kubectl set image deployment/$(SERVICE) $(SERVICE)=$(IMAGE) -n $(NAMESPACE)
	@kubectl rollout status deployment/$(SERVICE) -n $(NAMESPACE)
	@echo "$(GREEN)âœ… $(SERVICE) æ›´æ–°å®Œæˆ$(NC)"

rollback: ## å›æ»šæŒ‡å®šæœåŠ¡ (ä½¿ç”¨: make rollback SERVICE=user-service)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šæœåŠ¡åç§°: make rollback SERVICE=user-service$(NC)"; \
		exit 1; \
	fi
	@echo "$(CYAN)âª å›æ»š $(SERVICE)...$(NC)"
	@kubectl rollout undo deployment/$(SERVICE) -n $(NAMESPACE)
	@kubectl rollout status deployment/$(SERVICE) -n $(NAMESPACE)
	@echo "$(GREEN)âœ… $(SERVICE) å›æ»šå®Œæˆ$(NC)"

debug: ## è°ƒè¯•æ¨¡å¼ - åˆ›å»ºè°ƒè¯•Pod
	@echo "$(CYAN)ğŸ› åˆ›å»ºè°ƒè¯•Pod...$(NC)"
	@kubectl run debug-pod --image=busybox --rm -it --restart=Never -n $(NAMESPACE) -- sh

describe: ## æŸ¥çœ‹æŒ‡å®šèµ„æºè¯¦æƒ… (ä½¿ç”¨: make describe RESOURCE=pod/user-service-xxx)
	@if [ -z "$(RESOURCE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šèµ„æº: make describe RESOURCE=pod/user-service-xxx$(NC)"; \
		exit 1; \
	fi
	@kubectl describe $(RESOURCE) -n $(NAMESPACE)

port-forward: ## ç«¯å£è½¬å‘åˆ°æœ¬åœ° (ä½¿ç”¨: make port-forward SERVICE=api-gateway LOCAL_PORT=8080)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šæœåŠ¡åç§°: make port-forward SERVICE=api-gateway LOCAL_PORT=8080$(NC)"; \
		exit 1; \
	fi
	@LOCAL_PORT=$${LOCAL_PORT:-8080}; \
	echo "$(CYAN)ğŸ”— ç«¯å£è½¬å‘ $(SERVICE) åˆ°æœ¬åœ°ç«¯å£ $$LOCAL_PORT...$(NC)"; \
	kubectl port-forward service/$(SERVICE) $$LOCAL_PORT:80 -n $(NAMESPACE)

config: ## æ˜¾ç¤ºå½“å‰é…ç½®
	@echo "$(CYAN)âš™ï¸  å½“å‰é…ç½®:$(NC)"
	@echo "  é¡¹ç›®åç§°: $(PROJECT_NAME)"
	@echo "  å‘½åç©ºé—´: $(NAMESPACE)"
	@echo "  é•œåƒæ ‡ç­¾: $(IMAGE_TAG)"
	@echo "  é»˜è®¤å‰¯æœ¬æ•°: $(REPLICAS)"
	@echo "  ç¬¬ä¸€é˜¶æ®µé¡¹ç›®è·¯å¾„: $(ECOMMERCE_BASIC_PATH)"

# å¼€å‘ç¯å¢ƒå¿«æ·å‘½ä»¤
dev-deploy: build-images deploy ## å¼€å‘ç¯å¢ƒä¸€é”®éƒ¨ç½²

dev-restart: ## å¼€å‘ç¯å¢ƒé‡å¯æ‰€æœ‰æœåŠ¡
	@for service in user-service product-service order-service notification-service; do \
		make restart SERVICE=$$service; \
	done

dev-logs: ## å¼€å‘ç¯å¢ƒæŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
	@kubectl logs -f -l tier=backend -n $(NAMESPACE) --max-log-requests=10

# ç”Ÿäº§ç¯å¢ƒå‘½ä»¤
prod-check: ## ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥
	@echo "$(CYAN)ğŸ” ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥...$(NC)"
	@echo "$(BLUE)æ£€æŸ¥èµ„æºé™åˆ¶...$(NC)"
	@kubectl get pods -n $(NAMESPACE) -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].resources}{"\n"}{end}' || echo "æ— Podè¿è¡Œ"
	@echo ""
	@echo "$(BLUE)æ£€æŸ¥å¥åº·æ¢é’ˆ...$(NC)"
	@kubectl get pods -n $(NAMESPACE) -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].livenessProbe.httpGet.path}{"\n"}{end}' || echo "æ— å¥åº·æ¢é’ˆ"

version: ## æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
	@echo "$(CYAN)ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:$(NC)"
	@echo "  é¡¹ç›®ç‰ˆæœ¬: 1.0.0"
	@echo "  Kubernetesç‰ˆæœ¬: $$(kubectl version --short --client 2>/dev/null || echo 'æœªçŸ¥')"
	@echo "  Dockerç‰ˆæœ¬: $$(docker --version 2>/dev/null || echo 'æœªå®‰è£…')"
	@if command -v minikube >/dev/null 2>&1; then \
		echo "  Minikubeç‰ˆæœ¬: $$(minikube version --short 2>/dev/null || echo 'æœªè¿è¡Œ')"; \
	fi