# ==============================================================================
# ç”µå•†åº”ç”¨åŸºç¡€ç‰ˆ - Makefile
# é¡¹ç›®ç®¡ç†å’Œéƒ¨ç½²è‡ªåŠ¨åŒ–
# ==============================================================================

.PHONY: help build up down restart logs clean test health setup

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¡¹ç›®é…ç½®
PROJECT_NAME := ecommerce-basic
COMPOSE_FILE := docker-compose.yml
ENV_FILE := .env

# é¢œè‰²å®šä¹‰
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
CYAN := \033[0;36m
NC := \033[0m # No Color

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(CYAN)ç”µå•†åº”ç”¨åŸºç¡€ç‰ˆ - é¡¹ç›®ç®¡ç†å‘½ä»¤$(NC)"
	@echo "=================================="
	@echo ""
	@echo "$(YELLOW)åŸºç¡€å‘½ä»¤:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)ä½¿ç”¨ç¤ºä¾‹:$(NC)"
	@echo "  make setup     # åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ"
	@echo "  make up        # å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "  make logs      # æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "  make health    # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€"
	@echo "  make down      # åœæ­¢æ‰€æœ‰æœåŠ¡"

setup: ## åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ
	@echo "$(CYAN)ğŸ“ åˆå§‹åŒ–é¡¹ç›®ç¯å¢ƒ...$(NC)"
	@if [ ! -f $(ENV_FILE) ]; then \
		cp .env.example $(ENV_FILE); \
		echo "$(GREEN)âœ… å·²åˆ›å»º .env æ–‡ä»¶$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  .env æ–‡ä»¶å·²å­˜åœ¨$(NC)"; \
	fi
	@mkdir -p data/{postgres,redis,rabbitmq}
	@mkdir -p logs/{user-service,product-service,order-service,notification-service,nginx}
	@mkdir -p data/static data/product-images
	@echo "$(GREEN)âœ… ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ$(NC)"
	@echo "$(CYAN)ğŸ’¡ è¯·ç¼–è¾‘ .env æ–‡ä»¶é…ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡$(NC)"

build: setup ## æ„å»ºæ‰€æœ‰æœåŠ¡é•œåƒ
	@echo "$(CYAN)ğŸ”¨ æ„å»ºæœåŠ¡é•œåƒ...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) build --no-cache
	@echo "$(GREEN)âœ… é•œåƒæ„å»ºå®Œæˆ$(NC)"

up: setup ## å¯åŠ¨æ‰€æœ‰æœåŠ¡
	@echo "$(CYAN)ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ… æœåŠ¡å¯åŠ¨å®Œæˆ$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“‹ è®¿é—®åœ°å€:$(NC)"
	@echo "  ğŸŒ åº”ç”¨å…¥å£: http://localhost"
	@echo "  ğŸ‘¤ ç”¨æˆ·æœåŠ¡: http://localhost:5001"
	@echo "  ğŸ“¦ å•†å“æœåŠ¡: http://localhost:5002"
	@echo "  ğŸ“‹ è®¢å•æœåŠ¡: http://localhost:5003"
	@echo "  ğŸ“¬ é€šçŸ¥æœåŠ¡: http://localhost:5004"
	@echo "  ğŸ° RabbitMQç®¡ç†: http://localhost:15672"
	@echo ""
	@echo "$(CYAN)ğŸ’¡ è¿è¡Œ 'make health' æ£€æŸ¥æœåŠ¡çŠ¶æ€$(NC)"

up-build: ## æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
	@echo "$(CYAN)ğŸ”¨ æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) up -d --build
	@echo "$(GREEN)âœ… æœåŠ¡å¯åŠ¨å®Œæˆ$(NC)"

down: ## åœæ­¢æ‰€æœ‰æœåŠ¡
	@echo "$(CYAN)ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) down
	@echo "$(GREEN)âœ… æœåŠ¡å·²åœæ­¢$(NC)"

down-clean: ## åœæ­¢æœåŠ¡å¹¶æ¸…ç†æ•°æ®å·
	@echo "$(RED)ğŸ—‘ï¸  åœæ­¢æœåŠ¡å¹¶æ¸…ç†æ•°æ®å·...$(NC)"
	@echo "$(YELLOW)âš ï¸  è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼$(NC)"
	@read -p "ç¡®è®¤ç»§ç»­ï¼Ÿ[y/N] " confirm && [ "$$confirm" = "y" ] || exit 1
	@docker-compose -f $(COMPOSE_FILE) down -v
	@docker system prune -f
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

restart: ## é‡å¯æ‰€æœ‰æœåŠ¡
	@echo "$(CYAN)ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) restart
	@echo "$(GREEN)âœ… æœåŠ¡é‡å¯å®Œæˆ$(NC)"

restart-service: ## é‡å¯æŒ‡å®šæœåŠ¡ (ä½¿ç”¨: make restart-service SERVICE=user-service)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šæœåŠ¡åç§°: make restart-service SERVICE=user-service$(NC)"; \
		exit 1; \
	fi
	@echo "$(CYAN)ğŸ”„ é‡å¯æœåŠ¡: $(SERVICE)$(NC)"
	@docker-compose -f $(COMPOSE_FILE) restart $(SERVICE)
	@echo "$(GREEN)âœ… æœåŠ¡ $(SERVICE) é‡å¯å®Œæˆ$(NC)"

logs: ## æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
	@echo "$(CYAN)ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) logs -f

logs-service: ## æŸ¥çœ‹æŒ‡å®šæœåŠ¡æ—¥å¿— (ä½¿ç”¨: make logs-service SERVICE=user-service)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šæœåŠ¡åç§°: make logs-service SERVICE=user-service$(NC)"; \
		exit 1; \
	fi
	@echo "$(CYAN)ğŸ“‹ æŸ¥çœ‹ $(SERVICE) æœåŠ¡æ—¥å¿—...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) logs -f $(SERVICE)

status: ## æŸ¥çœ‹æœåŠ¡çŠ¶æ€
	@echo "$(CYAN)ğŸ“Š æœåŠ¡çŠ¶æ€:$(NC)"
	@docker-compose -f $(COMPOSE_FILE) ps

health: ## æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
	@echo "$(CYAN)ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€...$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“‹ å®¹å™¨çŠ¶æ€:$(NC)"
	@docker-compose -f $(COMPOSE_FILE) ps
	@echo ""
	@echo "$(YELLOW)ğŸ” å¥åº·æ£€æŸ¥:$(NC)"
	@for service in user product order notification; do \
		echo -n "  $$service-service: "; \
		if curl -sf http://localhost/health/$$service > /dev/null 2>&1; then \
			echo "$(GREEN)âœ… å¥åº·$(NC)"; \
		else \
			echo "$(RED)âŒ å¼‚å¸¸$(NC)"; \
		fi; \
	done
	@echo ""
	@echo "$(YELLOW)ğŸ“Š åŸºç¡€è®¾æ–½æœåŠ¡:$(NC)"
	@echo -n "  PostgreSQL: "
	@if docker-compose -f $(COMPOSE_FILE) exec -T postgres pg_isready -U postgres > /dev/null 2>&1; then \
		echo "$(GREEN)âœ… å¥åº·$(NC)"; \
	else \
		echo "$(RED)âŒ å¼‚å¸¸$(NC)"; \
	fi
	@echo -n "  Redis: "
	@if docker-compose -f $(COMPOSE_FILE) exec -T redis redis-cli ping > /dev/null 2>&1; then \
		echo "$(GREEN)âœ… å¥åº·$(NC)"; \
	else \
		echo "$(RED)âŒ å¼‚å¸¸$(NC)"; \
	fi
	@echo -n "  RabbitMQ: "
	@if docker-compose -f $(COMPOSE_FILE) exec -T rabbitmq rabbitmq-diagnostics ping > /dev/null 2>&1; then \
		echo "$(GREEN)âœ… å¥åº·$(NC)"; \
	else \
		echo "$(RED)âŒ å¼‚å¸¸$(NC)"; \
	fi

test: ## è¿è¡ŒAPIæµ‹è¯•
	@echo "$(CYAN)ğŸ§ª è¿è¡ŒAPIæµ‹è¯•...$(NC)"
	@echo "$(YELLOW)æµ‹è¯•ç”¨æˆ·æœåŠ¡...$(NC)"
	@curl -sf http://localhost/health/user > /dev/null || (echo "$(RED)âŒ ç”¨æˆ·æœåŠ¡ä¸å¯ç”¨$(NC)" && exit 1)
	@echo "$(GREEN)âœ… ç”¨æˆ·æœåŠ¡å¥åº·$(NC)"
	@echo "$(YELLOW)æµ‹è¯•å•†å“æœåŠ¡...$(NC)"
	@curl -sf http://localhost/health/product > /dev/null || (echo "$(RED)âŒ å•†å“æœåŠ¡ä¸å¯ç”¨$(NC)" && exit 1)
	@echo "$(GREEN)âœ… å•†å“æœåŠ¡å¥åº·$(NC)"
	@echo "$(YELLOW)æµ‹è¯•è®¢å•æœåŠ¡...$(NC)"
	@curl -sf http://localhost/health/order > /dev/null || (echo "$(RED)âŒ è®¢å•æœåŠ¡ä¸å¯ç”¨$(NC)" && exit 1)
	@echo "$(GREEN)âœ… è®¢å•æœåŠ¡å¥åº·$(NC)"
	@echo "$(YELLOW)æµ‹è¯•é€šçŸ¥æœåŠ¡...$(NC)"
	@curl -sf http://localhost/health/notification > /dev/null || (echo "$(RED)âŒ é€šçŸ¥æœåŠ¡ä¸å¯ç”¨$(NC)" && exit 1)
	@echo "$(GREEN)âœ… é€šçŸ¥æœåŠ¡å¥åº·$(NC)"
	@echo "$(GREEN)ğŸ‰ æ‰€æœ‰æœåŠ¡æµ‹è¯•é€šè¿‡$(NC)"

stats: ## æŸ¥çœ‹æœåŠ¡ç»Ÿè®¡ä¿¡æ¯
	@echo "$(CYAN)ğŸ“Š æœåŠ¡ç»Ÿè®¡ä¿¡æ¯:$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ‘¤ ç”¨æˆ·æœåŠ¡ç»Ÿè®¡:$(NC)"
	@curl -s http://localhost/stats/user | python3 -m json.tool 2>/dev/null || echo "  æœåŠ¡ä¸å¯ç”¨"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ å•†å“æœåŠ¡ç»Ÿè®¡:$(NC)"
	@curl -s http://localhost/stats/product | python3 -m json.tool 2>/dev/null || echo "  æœåŠ¡ä¸å¯ç”¨"
	@echo ""
	@echo "$(YELLOW)ğŸ“‹ è®¢å•æœåŠ¡ç»Ÿè®¡:$(NC)"
	@curl -s http://localhost/stats/order | python3 -m json.tool 2>/dev/null || echo "  æœåŠ¡ä¸å¯ç”¨"
	@echo ""
	@echo "$(YELLOW)ğŸ“¬ é€šçŸ¥æœåŠ¡ç»Ÿè®¡:$(NC)"
	@curl -s http://localhost/stats/notification | python3 -m json.tool 2>/dev/null || echo "  æœåŠ¡ä¸å¯ç”¨"

clean: ## æ¸…ç†Dockerèµ„æº
	@echo "$(CYAN)ğŸ§¹ æ¸…ç†Dockerèµ„æº...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) down
	@docker system prune -f
	@docker volume prune -f
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

shell: ## è¿›å…¥æŒ‡å®šæœåŠ¡å®¹å™¨ (ä½¿ç”¨: make shell SERVICE=user-service)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šæœåŠ¡åç§°: make shell SERVICE=user-service$(NC)"; \
		exit 1; \
	fi
	@echo "$(CYAN)ğŸš è¿›å…¥ $(SERVICE) å®¹å™¨...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) exec $(SERVICE) /bin/bash

db-backup: ## å¤‡ä»½æ•°æ®åº“
	@echo "$(CYAN)ğŸ’¾ å¤‡ä»½æ•°æ®åº“...$(NC)"
	@mkdir -p database/backups
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	docker-compose -f $(COMPOSE_FILE) exec -T postgres pg_dumpall -U postgres > database/backups/backup_$$timestamp.sql
	@echo "$(GREEN)âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ$(NC)"

db-restore: ## æ¢å¤æ•°æ®åº“ (ä½¿ç”¨: make db-restore BACKUP=backup_20240101_120000.sql)
	@if [ -z "$(BACKUP)" ]; then \
		echo "$(RED)âŒ è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶: make db-restore BACKUP=backup_20240101_120000.sql$(NC)"; \
		exit 1; \
	fi
	@if [ ! -f "database/backups/$(BACKUP)" ]; then \
		echo "$(RED)âŒ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: database/backups/$(BACKUP)$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)âš ï¸  è­¦å‘Šï¼šè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®åº“ï¼$(NC)"
	@read -p "ç¡®è®¤ç»§ç»­ï¼Ÿ[y/N] " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "$(CYAN)ğŸ“¥ æ¢å¤æ•°æ®åº“...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) exec -T postgres psql -U postgres < database/backups/$(BACKUP)
	@echo "$(GREEN)âœ… æ•°æ®åº“æ¢å¤å®Œæˆ$(NC)"

update: ## æ‹‰å–æœ€æ–°é•œåƒå¹¶é‡å¯æœåŠ¡
	@echo "$(CYAN)ğŸ”„ æ›´æ–°æœåŠ¡...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) pull
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ… æœåŠ¡æ›´æ–°å®Œæˆ$(NC)"

env: ## æ˜¾ç¤ºç¯å¢ƒå˜é‡
	@echo "$(CYAN)ğŸ”§ ç¯å¢ƒå˜é‡:$(NC)"
	@if [ -f $(ENV_FILE) ]; then \
		cat $(ENV_FILE) | grep -v '^#' | grep -v '^$$'; \
	else \
		echo "$(RED)âŒ .env æ–‡ä»¶ä¸å­˜åœ¨$(NC)"; \
	fi

version: ## æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
	@echo "$(CYAN)ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:$(NC)"
	@echo "  é¡¹ç›®åç§°: $(PROJECT_NAME)"
	@echo "  ç‰ˆæœ¬: 1.0.0"
	@echo "  Docker Compose: $$(docker-compose --version)"
	@echo "  Docker: $$(docker --version)"

# å¼€å‘ç¯å¢ƒå‘½ä»¤
dev-setup: ## è®¾ç½®å¼€å‘ç¯å¢ƒ
	@echo "$(CYAN)ğŸ› ï¸  è®¾ç½®å¼€å‘ç¯å¢ƒ...$(NC)"
	@make setup
	@echo "FLASK_ENV=development" >> $(ENV_FILE)
	@echo "LOG_LEVEL=DEBUG" >> $(ENV_FILE)
	@echo "$(GREEN)âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ$(NC)"

dev-up: ## å¯åŠ¨å¼€å‘ç¯å¢ƒ
	@echo "$(CYAN)ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ...$(NC)"
	@FLASK_ENV=development docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ… å¼€å‘ç¯å¢ƒå¯åŠ¨å®Œæˆ$(NC)"