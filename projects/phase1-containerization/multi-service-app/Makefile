.PHONY: help dev-up prod-up down status logs clean build test migrate seed backup restore

# é»˜è®¤ç›®æ ‡
help:
	@echo "Todo List Plus - Dockerç®¡ç†å‘½ä»¤"
	@echo ""
	@echo "å¼€å‘å‘½ä»¤:"
	@echo "  dev-up      å¯åŠ¨å¼€å‘ç¯å¢ƒ"
	@echo "  down        åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  restart     é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "  build       é‡æ–°æ„å»ºæ‰€æœ‰é•œåƒ"
	@echo ""
	@echo "ç›‘æ§å‘½ä»¤:"
	@echo "  status      æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  logs        æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "  logs-f      å®æ—¶æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo ""
	@echo "æ•°æ®åº“å‘½ä»¤:"
	@echo "  migrate     è¿è¡Œæ•°æ®åº“è¿ç§»"
	@echo "  seed        è½½å…¥ç§å­æ•°æ®"
	@echo "  backup      å¤‡ä»½æ•°æ®åº“"
	@echo "  restore     æ¢å¤æ•°æ®åº“"
	@echo ""
	@echo "ç»´æŠ¤å‘½ä»¤:"
	@echo "  clean       æ¸…ç†å®¹å™¨å’Œé•œåƒ"
	@echo "  test        è¿è¡Œæµ‹è¯•"


# Project setup and initialization
setup: db-init
	@echo "ğŸ”§ åˆå§‹åŒ–é¡¹ç›®..."
	@command -v docker >/dev/null 2>&1 || { echo "âŒ è¯·å…ˆå®‰è£…Docker"; exit 1; }
	@docker info >/dev/null 2>&1 || { echo "âŒ è¯·å¯åŠ¨DockeræœåŠ¡"; exit 1; }
	@echo "é¡¹ç›®åˆå§‹åŒ–å®Œæˆ"

# å¼€å‘ç¯å¢ƒç®¡ç†
dev-up:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	@cp -n .env.example .env 2>/dev/null || true
	@mkdir -p logs/{nginx,backend,database} data/{postgres,redis,uploads} backups
	@docker-compose up -d
	@echo "âœ… å¼€å‘ç¯å¢ƒå·²å¯åŠ¨"
	@echo "ğŸŒ å‰ç«¯: http://localhost:3000"
	@echo "ğŸ”§ åç«¯API: http://localhost:8000"
	@echo "ğŸ“– APIæ–‡æ¡£: http://localhost:8000/docs"

prod-up:
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ..."
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒå·²å¯åŠ¨"

down:
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@docker-compose down
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

restart:
	@echo "ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡..."
	@docker-compose restart
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²é‡å¯"

# æ„å»ºå’Œæ›´æ–°
build:
	@echo "ğŸ”¨ é‡æ–°æ„å»ºæ‰€æœ‰é•œåƒ..."
	@docker-compose build --no-cache
	@echo "âœ… é•œåƒæ„å»ºå®Œæˆ"

build-frontend:
	@echo "ğŸ”¨ é‡æ–°æ„å»ºå‰ç«¯é•œåƒ..."
	@docker-compose build --no-cache frontend
	@echo "âœ… å‰ç«¯é•œåƒæ„å»ºå®Œæˆ"

build-backend:
	@echo "ğŸ”¨ é‡æ–°æ„å»ºåç«¯é•œåƒ..."
	@docker-compose build --no-cache backend
	@echo "âœ… åç«¯é•œåƒæ„å»ºå®Œæˆ"

# ç›‘æ§å’Œè°ƒè¯•
status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
	@docker-compose ps

logs:
	@docker-compose logs

logs-f:
	@docker-compose logs -f

logs-frontend:
	@docker-compose logs -f frontend

logs-backend:
	@docker-compose logs -f backend

logs-database:
	@docker-compose logs -f database

logs-redis:
	@docker-compose logs -f redis

logs-nginx:
	@docker-compose logs -f nginx

# æ•°æ®åº“æ“ä½œ
migrate:
	@echo "ğŸ—ƒï¸ è¿è¡Œæ•°æ®åº“è¿ç§»..."
	@docker-compose exec backend alembic upgrade head
	@echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"

migrate-create:
	@echo "ğŸ—ƒï¸ åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶..."
	@read -p "è¿ç§»åç§°: " name; \
	docker-compose exec backend alembic revision --autogenerate -m "$$name"

seed:
	@echo "ğŸŒ± è½½å…¥ç§å­æ•°æ®..."
	@docker-compose exec backend python -c "from app.db.init_db import init_db; init_db()"
	@echo "âœ… ç§å­æ•°æ®è½½å…¥å®Œæˆ"

# å¤‡ä»½å’Œæ¢å¤
backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
	@mkdir -p backups
	@docker-compose exec database pg_dump -U postgres todo_db > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ"

restore:
	@echo "ğŸ”„ æ¢å¤æ•°æ®åº“..."
	@read -p "å¤‡ä»½æ–‡ä»¶è·¯å¾„: " backup_file; \
	docker-compose exec -T database psql -U postgres todo_db < "$$backup_file"
	@echo "âœ… æ•°æ®åº“æ¢å¤å®Œæˆ"

# æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@docker-compose exec backend python -m pytest tests/ -v
	@echo "âœ… æµ‹è¯•å®Œæˆ"

test-frontend:
	@echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•..."
	@docker-compose exec frontend npm test
	@echo "âœ… å‰ç«¯æµ‹è¯•å®Œæˆ"

test-backend:
	@echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
	@docker-compose exec backend python -m pytest tests/ -v --cov=app
	@echo "âœ… åç«¯æµ‹è¯•å®Œæˆ"

# ç»´æŠ¤å’Œæ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†èµ„æº..."
	@docker-compose down -v
	@docker system prune -f
	@docker volume prune -f
	@echo "âœ… æ¸…ç†å®Œæˆ"

clean-all:
	@echo "ğŸ§¹ å®Œå…¨æ¸…ç†..."
	@docker-compose down -v --rmi all
	@docker system prune -af
	@docker volume prune -f
	@echo "âœ… å®Œå…¨æ¸…ç†å®Œæˆ"



# å¼€å‘å·¥å…·
shell-backend:
	@docker-compose exec backend /bin/bash

shell-frontend:
	@docker-compose exec frontend /bin/sh

shell-database:
	@docker-compose exec database psql -U postgres todo_db

shell-redis:
	@docker-compose exec redis redis-cli -a redis123

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
	@echo "Frontend: $$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo "âŒ æ— æ³•è¿æ¥")"
	@echo "Backend: $$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health || echo "âŒ æ— æ³•è¿æ¥")"
	@echo "Database: $$(docker-compose exec -T database pg_isready -U postgres -d todo_db && echo "âœ… å¥åº·" || echo "âŒ å¼‚å¸¸")"
	@echo "Redis: $$(docker-compose exec -T redis redis-cli -a redis123 ping && echo "âœ… å¥åº·" || echo "âŒ å¼‚å¸¸")"